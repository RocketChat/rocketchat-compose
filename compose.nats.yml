services:
  nats:
    image: docker.io/nats:${NATS_VERSION:-2.11-alpine}
    restart: always
    expose:
      - 4222
      - 8222
      - 6222
    # healthcheck:
    #   test: ["CMD", "nc", "-zv", "-w", "10", "nats", "4222"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 10
    #   start_period: 30s
    command: --http_port 8222 -js -sd /data
    # In docker this won't have many replicas, so restart is complety data loss
    volumes:
      - nats_data:/data
    logging:
      driver: "journald"
      options:
        tag: "${COMPOSE_PROJECT_NAME:-rocketchat}#nats#{{.Name}}"

  nats-exporter:
    image: docker.io/natsio/prometheus-nats-exporter:${NATS_EXPORTER_VERSION:-0.17.3}
    depends_on:
      - nats
    expose:
      - 7777
    command:
      - -healthz
      - -varz
      - "http://nats:8222"
    logging:
      driver: "journald"
      options:
        tag: "${COMPOSE_PROJECT_NAME:-rocketchat}#nats-exporter#{{.Name}}"

volumes:
  nats_data:
    driver: local
